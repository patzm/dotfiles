{{ if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "debian") -}}
#! /usr/bin/env bash

set -e

OS_NAME="{{ .chezmoi.osRelease.name }}"
OS_MAJOR_VERSION=$(lsb_release -rs | cut -d. -f1)
if [[ ! "$OS_MAJOR_VERSION" =~ ^[0-9]+$ ]]; then
    OS_MAJOR_VERSION=0
fi

packages=(
    bat
    btop
    cmake
    direnv
    errands
    exiv2
    eza
    ffmpeg
    fzf
    gimp
    git
    git-delta
    imagemagick
    jq
    just
    libimage-exiftool-perl
    ncdu
    neovim
    pre-commit
    python3
    tmux
    virtualenvwrapper
    zsh
)

if [ "$OS_NAME" = "Ubuntu" ]; then
    packages+=(
        alacritty
        firefox
        handbrake
        inkscape
        meld
        picard
        sound-juicer
        thunderbird
        vlc
        rpi-imager
        torbrowser-launcher
    )
fi

fastfetch_available=0
use_fastfetch_ppa=0
if [ "$OS_NAME" = "Ubuntu" ]; then
    if [ "$OS_MAJOR_VERSION" -ge 25 ]; then
        fastfetch_available=1
    else
        fastfetch_available=1
        use_fastfetch_ppa=1
    fi
elif [ "$OS_NAME" = "Debian GNU/Linux" ] && [ "$OS_MAJOR_VERSION" -ge 13 ]; then
    fastfetch_available=1
fi

if [ "$fastfetch_available" -eq 1 ]; then
    packages+=(fastfetch)
fi

install_starship_with_apt=0
if [ "$OS_NAME" = "Ubuntu" ] && [ "$OS_MAJOR_VERSION" -ge 25 ]; then
    install_starship_with_apt=1
elif [ "$OS_NAME" = "Debian GNU/Linux" ] && [ "$OS_MAJOR_VERSION" -ge 13 ]; then
    install_starship_with_apt=1
fi

if [ "$install_starship_with_apt" -eq 1 ]; then
    packages+=(starship)
else
    if ! command -v starship >/dev/null 2>&1; then
        URL=https://starship.rs/install.sh
        printf "\nInstalling starship from %s\n" "$URL"
        curl -sS "$URL" | sh -s -- --yes > /dev/null
    fi
fi

snap_packages=(
    astral-uv
)

if [ "$use_fastfetch_ppa" -eq 1 ]; then
    sources_file=/etc/apt/sources.list.d/fastfetch-ubuntu.sources
    keyring=/etc/apt/keyrings/fastfetch-ppa.gpg
    sudo install -d -m 755 /etc/apt/keyrings
    curl -fsSL 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xEB65EE19D802F3EB1A13CFE47E2E5CB4D4865F21' \
        | gpg --dearmor \
        | sudo tee "$keyring" >/dev/null
    sudo chmod 644 "$keyring"
    if [ ! -f "$sources_file" ]; then
        printf "\nAdding fastfetch PPA\n"
        cat <<EOF | sudo tee "$sources_file" >/dev/null
Types: deb
URIs: https://ppa.launchpadcontent.net/zhangsongcui3371/fastfetch/ubuntu
Suites: noble
Components: main
Signed-By: $keyring
EOF
    fi
fi

printf "\nInstalling apt packages\n"
sudo DEBIAN_FRONTEND=noninteractive apt-get update
sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends "${packages[@]}"

printf "\nInstalling snap packages\n"
sudo snap install --classic "${snap_packages[@]}"

mkdir -p ~/.local/bin
ln -sf /usr/bin/batcat "$HOME/.local/bin/bat"

# vim: set filetype=zsh :
{{ end -}}
